# terraform-module-az-firewall-palo-alto

A Terraform module for deploying and bootstrapping Palo Alto VM-Series firewalls, as well as an internal load balancer in Azure cloud.
This module calls upon some of the official Palo Alto Terraform modules - see [terraform-azurerm-vmseries-modules](https://github.com/PaloAltoNetworks/terraform-azurerm-vmseries-modules/tree/main/modules) for more details.

## Changelog Guide

Refer to below guide to learn how `CHANGELOG.md` gets updated
<https://digitalcentral.edfenergy.com/pages/viewpage.action?pageId=186029053>

## Accept Azure Marketplace Terms

This module manages the acceptance of Azure Marketplace terms for BYOL VM-Series images.

If using PAYG (bundle1 or bundle2) plans, you must accept the Azure Marketplace terms before using this module. For example:

```sh
az vm image terms accept --publisher paloaltonetworks --offer vmseries-flex --plan bundle1 --subscription MySubscription
az vm image terms accept --publisher paloaltonetworks --offer vmseries-flex --plan bundle2 --subscription MySubscription
```

You can revoke the acceptance later with the `az vm image terms cancel` command.
The acceptance applies to the entirety of your Azure Subscription.

## Example Usage

Please refer to the confluence documentation <https://edfuk.atlassian.net/wiki/spaces/CLOUD/pages/638681862/T2+firewalls+-+EIS+Operational+Guide>

Example firewall config structure

```sh
firewalls  = {
  "a" = {
    zone                = 1,
    img_sku             = "byol",
    img_version         = "9.1.13",
    vm_size             = "Standard_D3_v2"
    enable_backend_pool = false
  }
}
```

- **zone**: Specifies the Availability Zone (AZ) where the virtual machine will be placed.
- **img_sku**: Defines the Stock Keeping Unit (SKU) of the image to be used for the VM.
- **img_version**: Indicates the specific version of the VM image.
- **vm_size**: Determines the size of the virtual machine, which dictates its processing and memory capacity.
- **managed_disk_type**: Specifies the type of managed disk to be used for VM storage (e.g., Standard_LRS, Premium_LRS).
- **enable_backend_pool**: A boolean flag (true or false). If set to false, the VM's private interfaces will not be associated with the specified load balancer backend pool.

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.3.1 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | ~> 3.7   |
| <a name="requirement_local"></a> [local](#requirement_local)             | ~> 2.4.0 |

## Providers

| Name                                                         | Version  |
| ------------------------------------------------------------ | -------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | ~> 3.7   |
| <a name="provider_random"></a> [random](#provider_random)    | >= 3.5.1 |
| <a name="provider_local"></a> [local](#provider_local)       | ~> 2.4.0 |

## Modules

| Name                                                                       | Source                                                                                               | Version     |
| -------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ----------- |
| <a name="module_bootstrap"></a> [bootstrap](#module_bootstrap)             | git::ssh://git@github.com/PaloAltoNetworks/terraform-azurerm-vmseries-modules.git//modules/bootstrap | tags/v1.0.5 |
| <a name="module_load_balancer"></a> [load_balancer](#module_load_balancer) | git::ssh://git@github.com/edfenergy/terraform-module-az-load-balancer.git                            | tags/2.0.0  |
| <a name="module_vmseries"></a> [vmseries](#module_vmseries)                | git::ssh://git@github.com/PaloAltoNetworks/terraform-azurerm-vmseries-modules.git//modules/vmseries  | tags/v1.0.5 |

## Resources

| Name                                                                                                                                                  | Type        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [azurerm_marketplace_agreement.palo_alto_byol](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/marketplace_agreement) | resource    |
| [local_sensitive_file.authcodes](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/sensitive_file)                        | resource    |
| [local_sensitive_file.init_cfg](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/sensitive_file)                         | resource    |
| [azurerm_key_vault_secret.password](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret)                 | resource    |
| [azurerm_key_vault_secret.username](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret)                 | resource    |
| [random_password.password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password)                                   | resource    |
| [azurerm_key_vault_secret.authcode](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret)              | data source |
| [azurerm_key_vault_secret.panorama_ip](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret)           | data source |
| [azurerm_key_vault_secret.password](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret)              | data source |
| [azurerm_key_vault_secret.username](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret)              | data source |
| [azurerm_key_vault_secret.vm_auth_key](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/key_vault_secret)           | data source |

## Inputs

| Name                                                                                                                  | Description                                                                                                                                                                                                                                                                              | Type                                                                                                                                                                                                                                           | Default                                                                          | Required |
| --------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | :------: |
| <a name="input_authcode_secret_name"></a> [authcode_secret_name](#input_authcode_secret_name)                         | The Key Vault secret name where the Palo Alto license authorisation code is stored. Required if enable bootstrap is true.                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_default_enable_backend_pool"></a> [default_enable_backend_pool](#input_default_enable_backend_pool)    | Whether to associate the VM private interfaces with the specified load balancer backend pool.                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                       | `true`                                                                           |    no    |
| <a name="input_default_img_sku"></a> [default_img_sku](#input_default_img_sku)                                        | VM-Series SKU - list available with `az vm image list -o table --all --publisher paloaltonetworks`                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                       | `"byol"`                                                                         |    no    |
| <a name="input_default_img_version"></a> [default_img_version](#input_default_img_version)                            | VM-Series PAN-OS version - list available with `az vm image list -o table --all --publisher paloaltonetworks`                                                                                                                                                                            | `string`                                                                                                                                                                                                                                       | `"9.1.13"`                                                                       |    no    |
| <a name="input_default_managed_disk_type"></a> [default_managed_disk_type](#input_default_managed_disk_type)          | Type of OS Managed Disk to create for the virtual machine. Possible values are `Standard_LRS`, `StandardSSD_LRS` or `Premium_LRS`. The `Premium_LRS` works only for selected `vm_size` values, details in Azure docs.                                                                    | `string`                                                                                                                                                                                                                                       | `"Premium_LRS"`                                                                  |    no    |
| <a name="input_default_vm_size"></a> [default_vm_size](#input_default_vm_size)                                        | Azure VM size (type) to be created.                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                       | `"Standard_DS4_v2"`                                                              |    no    |
| <a name="input_firewalls"></a> [firewalls](#input_firewalls)                                                          | Map of virtual machines to create. Each firewall object key is used in resource names and must be unique.<br>Each firewall object has the following keys:<br>- zone (AZ in which to place VM)<br>- img_sku<br>- img_version<br>- vm_size<br>- managed_disk_type<br>- enable_backend_pool | <pre>map(<br> object({<br> zone = number<br> img_sku = optional(string)<br> img_version = optional(string)<br> vm_size = optional(string)<br> managed_disk_type = optional(string)<br> enable_backend_pool = optional(bool)<br> })<br> )</pre> | <pre>{<br> "a": {<br> "zone": 1<br> },<br> "b": {<br> "zone": 2<br> }<br>}</pre> |    no    |
| <a name="input_internal_subnet_id"></a> [internal_subnet_id](#input_internal_subnet_id)                               | The firewall internal subnet ID.                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_key_vault_id"></a> [key_vault_id](#input_key_vault_id)                                                 | The ID of the Azure Key Vault instance where the firewall secrets are stored.                                                                                                                                                                                                            | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_load_balancer_private_ip"></a> [load_balancer_private_ip](#input_load_balancer_private_ip)             | The private IP address to assign to the internal load balancer. This IP **must** fall in the internal subnet.                                                                                                                                                                            | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_location"></a> [location](#input_location)                                                             | The Azure region to use.                                                                                                                                                                                                                                                                 | `string`                                                                                                                                                                                                                                       | `"UKSouth"`                                                                      |    no    |
| <a name="input_management_subnet_id"></a> [management_subnet_id](#input_management_subnet_id)                         | The firewall management subnet ID.                                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_panorama_device_group_name"></a> [panorama_device_group_name](#input_panorama_device_group_name)       | The Panorama template stack to assign the firewalls. Required if enable bootstrap is true.                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_panorama_ip_secret_name"></a> [panorama_ip_secret_name](#input_panorama_ip_secret_name)                | The Key Vault secret name where the panorama IP address is stored. Required if enable bootstrap is true                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_panorama_template_stack_name"></a> [panorama_template_stack_name](#input_panorama_template_stack_name) | The Panorama template stack to assign the firewalls. Required if enable bootstrap is true.                                                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_password_secret_name"></a> [password_secret_name](#input_password_secret_name)                         | The Key Vault secret name where the firewall admin password is stored. Required if use_existing_secrets is true.                                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_prefix"></a> [prefix](#input_prefix)                                                                   | Prefix for resource names                                                                                                                                                                                                                                                                | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name)                            | Name of the Resource Group to use.                                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                       | n/a                                                                              |   yes    |
| <a name="input_storage_account_name"></a> [storage_account_name](#input_storage_account_name)                         | Default name of the storage account to create. The name must be unique across Azure. Required if enable bootstrap is true                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                         | Map of tags to assign to the resources created.                                                                                                                                                                                                                                          | `map(string)`                                                                                                                                                                                                                                  | `{}`                                                                             |    no    |
| <a name="input_username_secret_name"></a> [username_secret_name](#input_username_secret_name)                         | The Key Vault secret name where the firewall admin username is stored. Required if use_existing_secrets is true.                                                                                                                                                                                                                   | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_vm_auth_key_secret_name"></a> [vm_auth_key_secret_name](#input_vm_auth_key_secret_name)                | The Key Vault secret name where the Panorama VM Authorisation key is stored. Required if enable bootstrap is true.                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   yes    |
| <a name="input_zones"></a> [zones](#input_zones)                                                                      | Load Balancer Availability Zone span.                                                                                                                                                                                                                                                    | `list(number)`                                                                                                                                                                                                                                 | <pre>[<br> 1,<br> 2,<br> 3<br>]</pre>                                            |    no    |
| <a name="input_enable_bootstrap"></a> [enable_bootstrap](#input_enable_bootstrap)                | bool value to whether to enable firewall bootstrap for module                                                                                                                                                                                                             | `bool`                                                                                                                                                                                                                                       | `true`                                                                           |   no    |
| <a name="input_enable_marketplace_agreement"></a> [enable_marketplace_agreement](#input_enable_marketplace_agreement)                | bool value to whether to enable firewall image marketplace agreement                                                                                                                                                                                                             | `bool`                                                                                                                                                                                                                                       | `true`                                                                           |   no    |
| <a name="input_use_existing_secrets"></a> [use_existing_secrets](#input_use_existing_secrets)                | bool value to determine whether to use existing stored secrets from keyvault                                                                                                                                                                                                             | `bool`                                                                                                                                                                                                                                       | `true`                                                                           |   no    |
| <a name="input_img_offer"></a> [img_offer](#input_img_offer)                | paloalto firewall image offer                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `vmseries-flex`                                                                           |   no    |
| <a name="input_img_plan"></a> [img_plan](#input_img_plan)                | paloalto firewall image plan                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `byol`                                                                           |   no    |
| <a name="input_vm_username"></a> [vm_username](#input_vm_username)                | paloalto firewall username                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   no    |
| <a name="input_vm_password"></a> [vm_username](#input_vm_password)                | paloalto firewall password                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   no    |
| <a name="input_diagnostics_storage_uri"></a> [diagnostics_storage_uri](#input_diagnostics_storage_uri)                | VM diagnostics uri for when enable bootstrap is false, default to null to use managed storage account                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                       | `null`                                                                           |   no    |

## Outputs

No outputs.

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
