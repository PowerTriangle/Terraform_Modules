# terraform-module-az-fortinet-fortiauthenticator

Terraform module to create fortiauthenticator Virtual Machine. It supports fortiauthenticator Azure images with configured NIC, managed osdisk, managed data disk etc. Module will build a Virtual Machine from a specified Fortinet fortiauthenticator Azure Marketplace image. Licensed types available: BYOL.
Disks' backups are designed to be deployed using separate backup vault module.

Default settings:

- BYOL licensing
- Credentials (random password) created and stored in Key Vault
- Enabled encryption at host using Customer Managed Keys
- High security type
- Storage Account type: "Premium_ZRS"
- OS disk size 64GB
- VM size: "Standard_D2as_v4"
- Image: publisher: "fortinet", offer: "fortinet-fortianalyzer", sku: "fortinet-fortianalyzer", version: "7.2.9", enable_marketplace_plan: true

## Module call

```text
module "fortiauthenticator" {
  source                  = "git@github.com:edfenergy/terraform-module-az-fortinet-fortiauthenticator?ref=1.0.0"
  resource_group_name     = var.rg_name
  resource_group_location = var.location
  vm_name                 = "eitprdhsfauth01"
  availability_zone       = 1
  image = {
    version                 = "6.0.2"
    publisher               = "fortinet"
    offer                   = "fortinet-fortiauthenticator-vm"
    sku                     = "fortinet-fac-vm"
    enable_marketplace_plan = true
  }
  enable_encryption_at_host = true
  # enable_secure_boot = true BadRequest: Use of TrustedLaunch setting is not supported for the provided image. Please select Trusted Launch Supported Gen2 OS Image
  vm_osdisk_size_gb      = 64
  disk_encryption_set_id = module.cmk_keyvault["cmk_encryption"].des_ids["cmk-des-02"]
  nics = {
    "00-eitprdhsfauth01" = {
      name                          = "eitprdhsfauth01-nic-01"
      enable_accelerated_networking = true
      enable_ip_forwarding          = false
      ip_configurations = {
        "ipconfig1" = {
          private_ip_address_allocation = "Static"
          private_ip_address            = "192.168.5.249"
          subnet_id                     = module.vnet.vnet_subnets_name_id["vm_subnet"]
        }
      }
    }
  }
  data_disks = {
    1 = {
      name   = "eitprdhsfauth01-datadisk-01"
      source = "new"
      size   = "64"
      class  = "Premium_ZRS"
    }
  }
  subscription_env_config = {
    boot_diagnostics_storage_uri = azurerm_storage_account.example.primary_blob_endpoint
    keyvault_id                  = azurerm_key_vault.firewall_keyvault.id
    vnet_id                      = module.vnet.vnet_id
  }
  tags = {
    business_unit = "finance"
    environment   = "test"
  }
}
```

## Code Quality

A number of tests are run against code as part of the GitHub super linter, as such they are not documented here other than links

### Super Linter

- All checks as defined inside the [GitHub super-linter](https://github.com/github/super-linter)

## Versioning

- Code to be tagged using [SemVer v2.0.0](https://semver.org/) standards.

As below, change x.y.z to the appropriate version increment:

```bash
git tag x.y.z && git push origin x.y.z
```

## Changelog Guide

Refer to below guide to learn how `CHANGELOG.md` gets updated
<https://digitalcentral.edfenergy.com/pages/viewpage.action?pageId=186029053>

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Requirements

| Name                                                                     | Version           |
| ------------------------------------------------------------------------ | ----------------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >=1.3.0           |
| <a name="requirement_azurerm"></a> [azurerm](#requirement_azurerm)       | >= 3.3.0, < 4.0.0 |
| <a name="requirement_random"></a> [random](#requirement_random)          | >= 3.5.1          |

## Providers

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | 3.112.0 |
| <a name="provider_random"></a> [random](#provider_random)    | 3.6.2   |

## Modules

No modules.

## Resources

| Name                                                                                                                                                                                   | Type     |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_key_vault_secret.password](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret)                                                  | resource |
| [azurerm_key_vault_secret.username](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault_secret)                                                  | resource |
| [azurerm_managed_disk.disks_data](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/managed_disk)                                                        | resource |
| [azurerm_network_interface.nics](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface)                                                    | resource |
| [azurerm_linux_virtual_machine.main](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine)                                            | resource |
| [azurerm_virtual_machine_data_disk_attachment.disks_data_attach](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_machine_data_disk_attachment) | resource |
| [random_password.password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password)                                                                    | resource |
| [azurerm_marketplace_agreement.fortinet](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/marketplace_agreement)                                        | resource |

## Inputs

| Name                                                                                                                     | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Type                                                                                                                                                                                                                                                    | Default                                                                                                                                                                                                       | Required |
| ------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| <a name="input_availability_zone"></a> [availability_zone](#input_availability_zone)                                     | Azure Availability Zone for VM and disks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `number`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_data_disks"></a> [data_disks](#input_data_disks)                                                          | [OPTIONAL] Data disks to create or copy and attach.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `map(any)`                                                                                                                                                                                                                                              | `{}`                                                                                                                                                                                                          |    no    |
| <a name="input_enable_accelerated_networking"></a> [enable_accelerated_networking](#input_enable_accelerated_networking) | Flag to enable accelerated networking on the VM's network interface.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `bool`                                                                                                                                                                                                                                                  | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_identity_ids"></a> [identity_ids](#input_identity_ids)                                                    | [OPTIONAL] Specifies a list of user assigned managed identity IDs for the VM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `list(string)`                                                                                                                                                                                                                                          | `[]`                                                                                                                                                                                                          |    no    |
| <a name="input_identity_type"></a> [identity_type](#input_identity_type)                                                 | [OPTIONAL] Specifies the type of managed service identity for the VM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                | `SystemAssigned`                                                                                                                                                                                              |    no    |
| <a name="input_network_subnet_name"></a> [network_subnet_name](#input_network_subnet_name)                               | Name of the subnet NIC should be deployed to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `string`                                                                                                                                                                                                                                                | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_nics"></a> [nics](#input_nics)                                                                            | [OPTIONAL] Multiple network interfaces to create and attach to vm.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <pre>map(object({<br> enable_accelerated_networking = optional(bool, null)<br> ip_configurations = optional(map(object({<br> subnet_id = string<br> private_ip_address = string<br> private_ip_address_allocation = string<br> })), null)<br> }))</pre> | `{}`                                                                                                                                                                                                          |    no    |
| <a name="input_resource_group_location"></a> [resource_group_location](#input_resource_group_location)                   | Resource Group location.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `string`                                                                                                                                                                                                                                                | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name)                               | Resource Group name.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `string`                                                                                                                                                                                                                                                | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_subscription_env_config"></a> [subscription_env_config](#input_subscription_env_config)                   | Object containing Subscription specific values.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `map(any)`                                                                                                                                                                                                                                              | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                            | Map of tags to apply to all possible resources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `map(any)`                                                                                                                                                                                                                                              | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_vm_hyper_v_generation"></a> [vm_hyper_v_generation](#input_vm_hyper_v_generation)                         | [OPTIONAL] Hyper-V Generation, possible values are V1 or V2.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `string`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_vm_name"></a> [vm_name](#input_vm_name)                                                                   | Name for VM resources to be deployed with.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_vm_os_disk_name"></a> [vm_os_disk_name](#input_vm_os_disk_name)                                           | OS Disk Name for the virtual machine.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_vm_osdisk_size_gb"></a> [vm_osdisk_size_gb](#input_vm_osdisk_size_gb)                                     | Size of OS disk to be deployed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `string`                                                                                                                                                                                                                                                | n/a                                                                                                                                                                                                           |   yes    |
| <a name="input_vm_setting_tags"></a> [vm_setting_tags](#input_vm_setting_tags)                                           | Tags used for managing Virtual Machines in the project for automation purposes. Tags such as UpdateWindow which governs the patching schedule for the VM, Backup to initiate an automated backup schedule and ssv2excludevm to exclude the VM from automated start/stop action                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `map(any)`                                                                                                                                                                                                                                              | `{}`                                                                                                                                                                                                          |    no    |
| <a name="input_vm_size"></a> [vm_size](#input_vm_size)                                                                   | fortianalyzer VM Size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `string`                                                                                                                                                                                                                                                | Standard_D8as_v4                                                                                                                                                                                              |    no    |
| <a name="input_vm_username"></a> [vm_username](#input_vm_username)                                                       | [OPTIONAL] Specifies username for the VM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `string`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_vm_password"></a> [vm_password](#input_vm_password)                                                       | [OPTIONAL] Specifies password for the VM. Shouldn't be used for production.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_vm_custom_data"></a> [vm_custom_data](#input_vm_custom_data)                                              | (Optional) The Base64-Encoded Custom Data which should be used for this Virtual Machine. Changing this forces a new resource to be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                                                                                                                                                                | `null`                                                                                                                                                                                                        |    no    |
| <a name="input_storage_account_type"></a> [storage_account_type](#input_storage_account_type)                            | Disk type used for OS disk.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `string`                                                                                                                                                                                                                                                | `Premium_ZRS`                                                                                                                                                                                                 |    no    |
| <a name="input_image"></a> [image](#input_image)                                                                         | <pre>Basic Azure VM configuration.<br><br> Following properties are available:<br><br> - version - (string, optional, defaults to 6.0.2) Fortinet FortiOS version; list available with<br> az vm image list --publisher fortinet --offer fortiauthenticator --all --output table table command.<br> - publisher - (string, optional, defaults to fortinet) the Azure Publisher identifier for an image<br> which should be deployed.<br> - offer - (string, optional, defaults to fortinet-fortiauthenticator-vm`) the Azure Offer identifier corresponding to a<br> published image.<br> - sku - (string, optional, defaults to fortinet-fac-vm) Fortinet fortiauthenticator SKU; list available with<br> az vm image list --publisher Fortinet --offer fortinet-fortiauthenticator --all --out table command.<br> - enable_marketplace_plan - (bool, optional, defaults to true) when set to true accepts the license for an offer/plan<br> on Azure Marketplace.<br> - custom_id - (string, optional, defaults to null) absolute ID of your own custom PAN-OS image to be used<br> for creating new Virtual Machines.<br><br> Important!<br> The custom_id and version properties are mutually exclusive.</pre> | <pre> type = object({<br> version = string<br> publisher = string<br> offer = string<br> sku = string<br> enable_marketplace_plan = bool<br> custom_id = optional(string)<br> })</pre>                                                                  | <pre>default = {<br> version = "6.0.2"<br> publisher = "fortinet"<br> offer = "fortinet-fortiauthenticator-vm"<br> sku = "fortinet-fac-vm"<br> enable_marketplace_plan = true<br> custom_id = null<br>}</pre> |    no    |
| <a name="input_enable_encryption_at_host"></a> [enable_encryption_at_host](#input_enable_encryption_at_host)             | all of the disks (including the temp disk) attached to this Virtual Machine be encrypted by enabling Encryption at Host                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `bool`                                                                                                                                                                                                                                                  | `true`                                                                                                                                                                                                        |    no    |
| <a name="input_secrets_already_exist"></a> [secrets_already_exist](#input_secrets_already_exist)                         | This variable value determines whether to create new secrets for VM. Otherwise variables vm_username and vm_password have to be defined.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `bool`                                                                                                                                                                                                                                                  | `false`                                                                                                                                                                                                       |    no    |
| <a name="input_enable_encryption_at_host"></a> [enable_encryption_at_host](#input_enable_encryption_at_host)             | all of the disks (including the temp disk) attached to this Virtual Machine be encrypted by enabling Encryption at Host                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `bool`                                                                                                                                                                                                                                                  | `true`                                                                                                                                                                                                        |    no    |

## Outputs

| Name                                                                                                        | Description                                     |
| ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| <a name="output_vm_network_interface_ids"></a> [vm_network_interface_ids](#output_vm_network_interface_ids) | List of NIC IDs                                 |
| <a name="output_vm_private_ips"></a> [vm_private_ips](#output_vm_private_ips)                               | List of Private IP addresses associated with VM |
| <a name="output_nics"></a> [nics](#output_nics)                                                             | Export objects of NICs.                         |
| <a name="output_vm"></a> [vm](#output_vm)                                                                   | Export of full vm object.                       |
| <a name="output_vm_id"></a> [vm_id](#output_vm_id)                                                          | ID of VM.                                       |
| <a name="output_vm_identity"></a> [vm_identity](#output_vm_identity)                                        | Identity used by VM.                            |
| <a name="output_data_disk_ids"></a> [data_disk_ids](#output_data_disk_ids)                                  | List of Data Disk IDs                           |
| <a name="output_os_disk_name"></a> [os_disk_name](#output_os_disk_name)                                     | OS Disk Name                                    |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
